<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS AUTO PRO 2026 - Gestión de Taller</title>
    <!-- Carga de Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, updateDoc, deleteDoc, where, addDoc, getDocs, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Carga de jsPDF
        window.jsPDF = await import("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");

        // Configuración de Colores Nexus en Tailwind (Gold: #FFD700)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nexus: {
                            black: '#1a1a1a',
                            gold: '#FFD700',
                            darkGold: '#ccaa00',
                        },
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }

        // --- INICIALIZACIÓN DE FIREBASE Y GLOBALES ---
        setLogLevel('debug'); // Habilitar logs para depuración

        // Variables globales (obligatorias)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAouzcePuYPfGBajbqFFotTNNr_gx_XCYQ",
            authDomain: "nexus-auto-pro-2026.firebaseapp.com",
            projectId: "nexus-auto-pro-2026",
            storageBucket: "nexus-auto-pro-2026.firebasestorage.app",
            messagingSenderId: "308014641424",
            appId: "1:308014641424:web:5157d1267e280c48eeb595"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let authReady = false;
        let priceList = []; // Cache para la lista de precios

        const initializeFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    authReady = true;
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `ID de Usuario: ${userId}`;
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('main-app').classList.remove('hidden');
                        setupRealtimeListeners(userId);
                        showPage('dashboard');
                        console.log("Usuario autenticado:", userId);
                    } else {
                        userId = null;
                        document.getElementById('auth-screen').classList.remove('hidden');
                        document.getElementById('main-app').classList.add('hidden');
                        console.log("Usuario no autenticado. Mostrando PIN/Login.");
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        };

        // Paths de Firestore
        const getPrivatePath = (uid, collectionName) => `artifacts/${appId}/users/${uid}/${collectionName}`;

        // --- GESTIÓN DE AUTENTICACIÓN ---

        window.handlePinLogin = async () => {
            const pin = document.getElementById('pin-input').value;
            if (!pin || pin.length < 4) {
                showNotification('El PIN debe tener 4 o más dígitos.', 'warning');
                return;
            }

            try {
                // En un entorno real, el PIN se usaría para buscar un token o credenciales.
                // Aquí, lo usaremos para simular la autenticación si coincide con el PIN guardado en Configuración.
                const configDocRef = doc(db, getPrivatePath(userId || 'default-pin-user', 'config'), 'workshop');
                const configSnap = await getDoc(configDocRef);
                const storedPin = configSnap.exists() ? configSnap.data().pin : '2026'; // PIN por defecto

                if (pin === storedPin) {
                    // Simulación: Si el PIN es correcto, iniciamos sesión anónima (o ya estamos en una)
                    // y forzamos la recarga del estado del usuario.
                    if (!userId) {
                         await signInAnonymously(auth);
                    } else {
                        // Si ya estamos autenticados, simplemente navegamos a la app
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('main-app').classList.remove('hidden');
                        showPage('dashboard');
                    }
                } else {
                    showNotification('PIN incorrecto. Intente de nuevo.', 'error');
                }
            } catch (error) {
                console.error("Error al validar PIN:", error);
                showNotification('Error de sistema al validar PIN.', 'error');
            }
        };

        window.handleGoogleLogin = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged manejará la navegación
            } catch (error) {
                console.error("Error de Google Auth:", error);
                showNotification(`Error de Google Auth: ${error.message}`, 'error');
            }
        };

        window.handleLogout = async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged manejará la vuelta a la pantalla de Auth
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showNotification(`Error al cerrar sesión: ${error.message}`, 'error');
            }
        };

        window.showPinScreen = () => {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('pin-input').value = '';
        };


        // --- UTILIDADES GLOBALES Y UI ---

        window.showNotification = (message, type = 'info') => {
            const container = document.getElementById('notification-container');
            const color = type === 'error' ? 'bg-red-500' : (type === 'warning' ? 'bg-yellow-500' : 'bg-nexus-gold');
            const text = type === 'error' ? 'text-white' : (type === 'warning' ? 'text-gray-900' : 'text-nexus-black');

            const notif = document.createElement('div');
            notif.className = `p-3 my-2 rounded-lg shadow-xl ${color} ${text} transition-opacity duration-300`;
            notif.textContent = message;

            container.appendChild(notif);

            setTimeout(() => {
                notif.classList.add('opacity-0');
                notif.addEventListener('transitionend', () => notif.remove());
            }, 3000);
        };

        window.showPage = (pageId) => {
            if (!authReady || !userId) {
                showNotification("Error de autenticación. Intente iniciar sesión de nuevo.", 'error');
                return;
            }
            document.querySelectorAll('.app-page').forEach(page => page.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');

            document.querySelectorAll('.menu-button').forEach(btn => {
                btn.classList.remove('bg-nexus-gold', 'text-nexus-black');
                btn.classList.add('bg-nexus-black', 'text-nexus-gold', 'hover:bg-nexus-gold', 'hover:text-nexus-black');
            });
            const activeBtn = document.getElementById(`btn-${pageId}`);
            if (activeBtn) {
                activeBtn.classList.add('bg-nexus-gold', 'text-nexus-black');
                activeBtn.classList.remove('bg-nexus-black', 'text-nexus-gold', 'hover:bg-nexus-gold', 'hover:text-nexus-black');
            }

            // Lógica específica al cargar módulos
            if (pageId === 'clients') loadClients();
            if (pageId === 'suppliers') loadSuppliers();
            if (pageId === 'price-list') loadPriceList();
            if (pageId === 'payments-reports') loadPayments();
            if (pageId === 'deliveries-history') loadVehicleHistory();
            if (pageId === 'quotes') loadQuotes();
            if (pageId === 'invoices') loadInvoices();
        };

        window.formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-PR', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        };

        window.formatDate = (date) => {
            if (!date) return '';
            const d = date instanceof Date ? date : new Date(date);
            return d.toLocaleDateString('es-PR');
        }

        // --- CONEXIONES REAL-TIME (FIRESTORE) ---

        const setupRealtimeListeners = (uid) => {
            // Escuchador para la lista de precios (usado en Cotizaciones/Facturas)
            const priceListRef = collection(db, getPrivatePath(uid, 'priceList'));
            onSnapshot(priceListRef, (snapshot) => {
                priceList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Esto no activa una recarga inmediata, sino que actualiza el caché
                // Las funciones de carga de módulo deben usar este caché actualizado.
                console.log("Lista de Precios actualizada en caché.");
            }, (error) => {
                console.error("Error al escuchar lista de precios:", error);
            });

            // Escuchador para Configuración del Taller
            const configRef = doc(db, getPrivatePath(uid, 'config'), 'workshop');
            onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('workshop-name').textContent = data.name || 'Taller Nexus Auto Pro 2026';
                    // Cargar al módulo de configuración
                    document.getElementById('config-workshop-name').value = data.name || '';
                    document.getElementById('config-address').value = data.address || '';
                    document.getElementById('config-phone').value = data.phone || '';
                    document.getElementById('config-email').value = data.email || '';
                    document.getElementById('config-hours').value = data.hours || '';
                    document.getElementById('current-pin-display').textContent = data.pin || '2026 (Default)';
                } else {
                    document.getElementById('workshop-name').textContent = 'Taller Nexus Auto Pro 2026 (Configurar)';
                }
            }, (error) => {
                console.error("Error al escuchar configuración:", error);
            });
        };


        // --- CRUD BÁSICO DE FIRESTORE ---

        const saveDocument = async (collectionName, data, docId = null) => {
            const collectionRef = collection(db, getPrivatePath(userId, collectionName));
            try {
                if (docId) {
                    const docRef = doc(collectionRef, docId);
                    await updateDoc(docRef, { ...data, updatedAt: serverTimestamp() });
                    showNotification(`Registro de ${collectionName.slice(0, -1)} actualizado con éxito.`, 'info');
                    return docId;
                } else {
                    const docRef = await addDoc(collectionRef, { ...data, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                    showNotification(`Nuevo registro de ${collectionName.slice(0, -1)} creado con éxito.`, 'success');
                    return docRef.id;
                }
            } catch (error) {
                console.error(`Error al guardar en ${collectionName}:`, error);
                showNotification(`Error al guardar el registro: ${error.message}`, 'error');
                return null;
            }
        };

        const deleteDocument = async (collectionName, docId) => {
            try {
                await deleteDoc(doc(db, getPrivatePath(userId, collectionName), docId));
                showNotification(`Registro eliminado con éxito.`, 'warning');
            } catch (error) {
                console.error(`Error al eliminar en ${collectionName}:`, error);
                showNotification(`Error al eliminar el registro: ${error.message}`, 'error');
            }
        };

        // --- MÓDULO 1: CONFIGURACIÓN ---

        window.saveWorkshopConfig = async () => {
            const data = {
                name: document.getElementById('config-workshop-name').value,
                address: document.getElementById('config-address').value,
                phone: document.getElementById('config-phone').value,
                email: document.getElementById('config-email').value,
                hours: document.getElementById('config-hours').value,
                logoUrl: document.getElementById('config-logo').value,
            };
            try {
                await setDoc(doc(db, getPrivatePath(userId, 'config'), 'workshop'), data, { merge: true });
                showNotification('Configuración del taller guardada.', 'success');
            } catch (error) {
                console.error("Error al guardar configuración:", error);
                showNotification(`Error al guardar configuración: ${error.message}`, 'error');
            }
        };

        window.changePin = async () => {
            const oldPin = document.getElementById('config-old-pin').value;
            const newPin = document.getElementById('config-new-pin').value;
            const confirmPin = document.getElementById('config-confirm-pin').value;

            if (newPin !== confirmPin) {
                showNotification('El nuevo PIN y la confirmación no coinciden.', 'warning');
                return;
            }
            if (newPin.length < 4 || newPin.length > 6) {
                showNotification('El PIN debe tener entre 4 y 6 dígitos.', 'warning');
                return;
            }

            try {
                // Validación del PIN anterior (simulada, usando el valor almacenado en Firestore)
                const configDocRef = doc(db, getPrivatePath(userId, 'config'), 'workshop');
                const configSnap = await getDoc(configDocRef);
                const storedPin = configSnap.exists() ? configSnap.data().pin : '2026'; // Default

                if (oldPin === storedPin) {
                    await updateDoc(configDocRef, { pin: newPin });
                    document.getElementById('current-pin-display').textContent = newPin;
                    showNotification('PIN de acceso actualizado con éxito.', 'success');
                    document.getElementById('config-old-pin').value = document.getElementById('config-new-pin').value = document.getElementById('config-confirm-pin').value = '';
                } else {
                    showNotification('PIN anterior incorrecto.', 'error');
                }

            } catch (error) {
                console.error("Error al cambiar PIN:", error);
                showNotification(`Error al cambiar PIN: ${error.message}`, 'error');
            }
        };

        // --- MÓDULO 2: CLIENTES (LISTAS MAESTRAS) ---

        window.loadClients = async () => {
            const q = query(collection(db, getPrivatePath(userId, 'clients')));
            onSnapshot(q, (snapshot) => {
                const clientList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderClientList(clientList);
            }, (error) => console.error("Error al cargar clientes:", error));
        };

        const renderClientList = (clients) => {
            const container = document.getElementById('clients-list-container');
            container.innerHTML = '';

            if (clients.length === 0) {
                container.innerHTML = `<p class="text-nexus-gold/70 mt-4">No hay clientes registrados.</p>`;
                return;
            }

            clients.forEach(client => {
                const clientEl = document.createElement('div');
                clientEl.className = 'flex justify-between items-center p-3 border-b border-nexus-gold/20 hover:bg-nexus-black/50';
                clientEl.innerHTML = `
                    <div>
                        <p class="font-bold text-nexus-gold">${client.name}</p>
                        <p class="text-sm text-white/70">Tel: ${client.phone || 'N/A'} | Dir: ${client.address || 'N/A'}</p>
                    </div>
                    <div>
                        <button onclick="editClient('${client.id}')" class="text-sm font-semibold text-nexus-gold hover:text-white mr-3">Editar</button>
                        <button onclick="deleteDocument('clients', '${client.id}')" class="text-sm font-semibold text-red-500 hover:text-red-300">Eliminar</button>
                    </div>
                `;
                container.appendChild(clientEl);
            });
        };

        window.saveClient = async () => {
            const id = document.getElementById('client-id').value;
            const data = {
                name: document.getElementById('client-name').value,
                phone: document.getElementById('client-phone').value,
                address: document.getElementById('client-address').value,
                email: document.getElementById('client-email').value,
            };
            await saveDocument('clients', data, id || null);
            document.getElementById('client-form').reset();
            document.getElementById('client-id').value = '';
        };

        window.editClient = async (id) => {
            const docSnap = await getDoc(doc(db, getPrivatePath(userId, 'clients'), id));
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('client-id').value = id;
                document.getElementById('client-name').value = data.name;
                document.getElementById('client-phone').value = data.phone;
                document.getElementById('client-address').value = data.address;
                document.getElementById('client-email').value = data.email;
                showNotification(`Editando cliente: ${data.name}`, 'info');
                // Scroll para ver el formulario
                document.getElementById('client-form').scrollIntoView({ behavior: 'smooth' });
            }
        };

        // --- MÓDULO 3: ENTRADAS DE VEHÍCULOS ---

        window.saveVehicleEntry = async () => {
            const form = document.getElementById('vehicle-entry-form');
            const data = {
                clientName: form['entry-client-name'].value,
                clientPhone: form['entry-client-phone'].value,
                clientAddress: form['entry-client-address'].value,
                plate: form['entry-plate'].value,
                color: form['entry-color'].value,
                makeModel: form['entry-make-model'].value,
                vin: form['entry-vin'].value,
                workType: form['entry-work-type'].value,
                suggestedWork: form['entry-suggested-work'].value,
                diagnosis: form['entry-diagnosis'].value,
                mechRepair: form['entry-mech-repair'].value,
                bodyRepair: form['entry-body-repair'].value,
                paintWork: form['entry-paint-work'].value,
                entryDate: form['entry-date'].value,
                status: form['entry-status'].value,
            };
            await saveDocument('vehicleEntries', data);
            form.reset();
        };

        // --- MÓDULO 4: LISTA DE PRECIOS ---

        window.loadPriceList = async () => {
            // Usa el caché actualizado por el listener de Firestore
            renderPriceList(priceList);
        };

        const renderPriceList = (list) => {
            const container = document.getElementById('price-list-container');
            container.innerHTML = '';
            const categories = [...new Set(list.map(item => item.category))];

            categories.forEach(cat => {
                const catItems = list.filter(item => item.category === cat);
                let html = `<h3 class="text-xl font-bold text-nexus-gold mt-6 mb-3">${cat}</h3>`;
                catItems.forEach(item => {
                    html += `
                        <div class="flex justify-between items-center p-2 border-b border-nexus-gold/10 hover:bg-nexus-black/50">
                            <div class="flex-grow">
                                <p class="font-semibold text-white">${item.name}</p>
                                <p class="text-sm text-white/70">${item.description || ''}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-nexus-gold font-bold">${formatCurrency(item.price)}</p>
                                <button onclick="editPriceItem('${item.id}')" class="text-xs text-nexus-gold/80 hover:text-white mr-2">Editar</button>
                                <button onclick="deleteDocument('priceList', '${item.id}')" class="text-xs text-red-500 hover:text-red-300">Eliminar</button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML += html;
            });
        };

        window.savePriceItem = async () => {
            const id = document.getElementById('price-item-id').value;
            const data = {
                name: document.getElementById('price-item-name').value,
                category: document.getElementById('price-item-category').value,
                description: document.getElementById('price-item-description').value,
                price: parseFloat(document.getElementById('price-item-price').value) || 0,
            };
            await saveDocument('priceList', data, id || null);
            document.getElementById('price-item-form').reset();
            document.getElementById('price-item-id').value = '';
        };

        window.editPriceItem = async (id) => {
            const item = priceList.find(i => i.id === id);
            if (item) {
                document.getElementById('price-item-id').value = id;
                document.getElementById('price-item-name').value = item.name;
                document.getElementById('price-item-category').value = item.category;
                document.getElementById('price-item-description').value = item.description;
                document.getElementById('price-item-price').value = item.price;
                showNotification(`Editando ítem: ${item.name}`, 'info');
                document.getElementById('price-item-form').scrollIntoView({ behavior: 'smooth' });
            }
        };

        // --- MÓDULO 5: SUPLIDORES (LISTAS MAESTRAS) ---

        window.loadSuppliers = async () => {
            const q = query(collection(db, getPrivatePath(userId, 'suppliers')));
            onSnapshot(q, (snapshot) => {
                const supplierList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSupplierList(supplierList);
            }, (error) => console.error("Error al cargar suplidores:", error));
        };

        const renderSupplierList = (suppliers) => {
            const container = document.getElementById('suppliers-list-container');
            container.innerHTML = '';
            if (suppliers.length === 0) {
                container.innerHTML = `<p class="text-nexus-gold/70 mt-4">No hay suplidores registrados.</p>`;
                return;
            }
            suppliers.forEach(supplier => {
                const supplierEl = document.createElement('div');
                supplierEl.className = 'flex justify-between items-center p-3 border-b border-nexus-gold/20 hover:bg-nexus-black/50';
                supplierEl.innerHTML = `
                    <div>
                        <p class="font-bold text-nexus-gold">${supplier.name}</p>
                        <p class="text-sm text-white/70">Tel: ${supplier.phone || 'N/A'} | Email: ${supplier.email || 'N/A'}</p>
                        <p class="text-xs text-white/50">${supplier.notes || ''}</p>
                    </div>
                    <div>
                        <button onclick="editSupplier('${supplier.id}')" class="text-sm font-semibold text-nexus-gold hover:text-white mr-3">Editar</button>
                        <button onclick="deleteDocument('suppliers', '${supplier.id}')" class="text-sm font-semibold text-red-500 hover:text-red-300">Eliminar</button>
                    </div>
                `;
                container.appendChild(supplierEl);
            });
        };

        window.saveSupplier = async () => {
            const id = document.getElementById('supplier-id').value;
            const data = {
                name: document.getElementById('supplier-name').value,
                phone: document.getElementById('supplier-phone').value,
                address: document.getElementById('supplier-address').value,
                email: document.getElementById('supplier-email').value,
                notes: document.getElementById('supplier-notes').value,
            };
            await saveDocument('suppliers', data, id || null);
            document.getElementById('supplier-form').reset();
            document.getElementById('supplier-id').value = '';
        };

        window.editSupplier = async (id) => {
            const docSnap = await getDoc(doc(db, getPrivatePath(userId, 'suppliers'), id));
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('supplier-id').value = id;
                document.getElementById('supplier-name').value = data.name;
                document.getElementById('supplier-phone').value = data.phone;
                document.getElementById('supplier-address').value = data.address;
                document.getElementById('supplier-email').value = data.email;
                document.getElementById('supplier-notes').value = data.notes;
                showNotification(`Editando suplidor: ${data.name}`, 'info');
                document.getElementById('supplier-form').scrollIntoView({ behavior: 'smooth' });
            }
        };

        // --- MÓDULO 6: COTIZACIONES & FACTURAS (Comparten Lógica) ---

        // Función para cargar los datos de la lista de precios en el formulario de detalle
        window.loadPriceItemsToSelect = (selectId) => {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- Seleccionar Ítem --</option>';
            priceList.forEach(item => {
                const option = document.createElement('option');
                option.value = JSON.stringify(item);
                option.textContent = `${item.name} (${formatCurrency(item.price)})`;
                select.appendChild(option);
            });
        };

        window.addItemToDocument = (docType) => {
            const selectId = docType === 'quote' ? 'quote-price-item-select' : 'invoice-price-item-select';
            const tableBodyId = docType === 'quote' ? 'quote-items-body' : 'invoice-items-body';
            const select = document.getElementById(selectId);
            const tableBody = document.getElementById(tableBodyId);

            if (!select.value) {
                showNotification('Seleccione un ítem de la lista de precios.', 'warning');
                return;
            }

            const itemData = JSON.parse(select.value);
            const quantity = parseFloat(document.getElementById(`${docType}-item-qty`).value) || 1;
            const price = itemData.price;
            const total = quantity * price;

            const row = document.createElement('tr');
            row.className = 'text-sm border-t border-nexus-gold/20';
            row.innerHTML = `
                <td class="p-2">${itemData.name}</td>
                <td class="p-2">${itemData.category}</td>
                <td class="p-2 text-right">${quantity}</td>
                <td class="p-2 text-right">${formatCurrency(price)}</td>
                <td class="p-2 text-right font-bold">${formatCurrency(total)}</td>
                <td class="p-2 text-center">
                    <button type="button" onclick="this.closest('tr').remove(); calculateTotals('${docType}')" class="text-red-500 hover:text-red-300">X</button>
                </td>
            `;
            tableBody.appendChild(row);

            // Resetear y recalcular
            select.value = '';
            document.getElementById(`${docType}-item-qty`).value = '1';
            calculateTotals(docType);
        };

        window.calculateTotals = (docType) => {
            const tableBodyId = docType === 'quote' ? 'quote-items-body' : 'invoice-items-body';
            const items = document.getElementById(tableBodyId).querySelectorAll('tr');
            let subtotal = 0;

            items.forEach(row => {
                // Obtener el total de la 5ta columna (índice 4)
                const totalText = row.children[4].textContent.replace('$', '').replace(/,/g, '');
                subtotal += parseFloat(totalText);
            });

            const taxRate = docType === 'invoice' ? (parseFloat(document.getElementById('invoice-tax-rate').value) / 100 || 0.115) : 0; // Ejemplo 11.5% IVU PR
            const taxAmount = subtotal * taxRate;
            const grandTotal = subtotal + taxAmount;

            document.getElementById(`${docType}-subtotal`).textContent = formatCurrency(subtotal);
            if (docType === 'invoice') {
                document.getElementById('invoice-tax-amount').textContent = formatCurrency(taxAmount);
            }
            document.getElementById(`${docType}-total`).textContent = formatCurrency(grandTotal);

            return { subtotal, taxAmount: docType === 'invoice' ? taxAmount : 0, total: grandTotal, items };
        };

        window.preparePDFData = (docType, docData, workshopConfig) => {
            const tableBodyId = docType === 'quote' ? 'quote-items-body' : 'invoice-items-body';
            const itemsData = Array.from(document.getElementById(tableBodyId).querySelectorAll('tr')).map(row => {
                return {
                    name: row.children[0].textContent,
                    qty: row.children[2].textContent,
                    price: row.children[3].textContent,
                    total: row.children[4].textContent,
                };
            });
            const totals = calculateTotals(docType);

            return {
                type: docType,
                title: docType === 'quote' ? `COTIZACIÓN #${docData.id || 'BORRADOR'}` : `FACTURA #${docData.id || 'BORRADOR'}`,
                workshop: workshopConfig,
                client: {
                    name: docData.clientName,
                    address: docData.clientAddress,
                    phone: docData.clientPhone,
                },
                vehicle: {
                    plate: docData.plate,
                    makeModel: docData.makeModel,
                    vin: docData.vin,
                },
                details: itemsData,
                subtotal: formatCurrency(totals.subtotal),
                taxAmount: formatCurrency(totals.taxAmount),
                total: formatCurrency(totals.total),
                date: new Date().toLocaleDateString('es-PR'),
                status: docData.status,
            };
        };

        // --- MÓDULO 6A: COTIZACIONES (CRUD & PDF) ---

        window.loadQuotes = async () => {
            const q = query(collection(db, getPrivatePath(userId, 'quotes')));
            onSnapshot(q, (snapshot) => {
                const quotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().createdAt?.toDate() }));
                renderQuotesList(quotes);
            }, (error) => console.error("Error al cargar cotizaciones:", error));
            loadPriceItemsToSelect('quote-price-item-select');
        };

        const renderQuotesList = (quotes) => {
             // Lógica de renderizado simple para la lista de cotizaciones
             const container = document.getElementById('quotes-list-container');
             container.innerHTML = '';
             quotes.sort((a, b) => b.date - a.date); // Sort by newest first

             quotes.forEach(q => {
                 const quoteEl = document.createElement('div');
                 quoteEl.className = 'flex justify-between items-center p-3 border-b border-nexus-gold/20 hover:bg-nexus-black/50';
                 quoteEl.innerHTML = `
                     <div>
                         <p class="font-bold text-nexus-gold">#${q.id.substring(0, 8)} - ${q.clientName}</p>
                         <p class="text-sm text-white/70">${q.makeModel} (${q.plate}) | Total: ${q.totalAmount ? formatCurrency(q.totalAmount) : 'N/A'}</p>
                         <p class="text-xs text-white/50">Fecha: ${formatDate(q.date)}</p>
                     </div>
                     <div>
                         <button onclick="generatePDF('quote', '${q.id}')" class="text-sm font-semibold text-nexus-gold hover:text-white mr-3">Imprimir PDF</button>
                         <button onclick="createInvoiceFromQuote('${q.id}')" class="text-sm font-semibold text-green-500 hover:text-green-300 mr-3">Crear Factura</button>
                         <button onclick="deleteDocument('quotes', '${q.id}')" class="text-sm font-semibold text-red-500 hover:text-red-300">Eliminar</button>
                     </div>
                 `;
                 container.appendChild(quoteEl);
             });
        }

        window.saveQuote = async () => {
            const form = document.getElementById('quote-form');
            const totals = calculateTotals('quote');

            const itemsData = Array.from(document.getElementById('quote-items-body').querySelectorAll('tr')).map(row => {
                return {
                    name: row.children[0].textContent,
                    qty: parseFloat(row.children[2].textContent),
                    price: parseFloat(row.children[3].textContent.replace('$', '').replace(/,/g, '')),
                };
            });

            const data = {
                clientName: form['quote-client-name'].value,
                clientPhone: form['quote-client-phone'].value,
                clientAddress: form['quote-client-address'].value,
                plate: form['quote-plate'].value,
                makeModel: form['quote-make-model'].value,
                vin: form['quote-vin'].value,
                totalAmount: totals.total,
                items: itemsData,
                status: 'Borrador',
            };
            await saveDocument('quotes', data);
            form.reset();
            document.getElementById('quote-items-body').innerHTML = '';
            calculateTotals('quote');
        };

        // --- MÓDULO 6B: FACTURAS (CRUD & PDF) ---

        window.loadInvoices = async () => {
            const q = query(collection(db, getPrivatePath(userId, 'invoices')));
            onSnapshot(q, (snapshot) => {
                const invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().createdAt?.toDate() }));
                renderInvoicesList(invoices);
            }, (error) => console.error("Error al cargar facturas:", error));
            loadPriceItemsToSelect('invoice-price-item-select');
        };

        const renderInvoicesList = (invoices) => {
            // Lógica de renderizado simple para la lista de facturas
            const container = document.getElementById('invoices-list-container');
            container.innerHTML = '';
            invoices.sort((a, b) => b.date - a.date); // Sort by newest first

            invoices.forEach(i => {
                const statusClass = i.status === 'Pagada' ? 'bg-green-600' : 'bg-yellow-600';
                const invoiceEl = document.createElement('div');
                invoiceEl.className = 'flex justify-between items-center p-3 border-b border-nexus-gold/20 hover:bg-nexus-black/50';
                invoiceEl.innerHTML = `
                    <div>
                        <p class="font-bold text-nexus-gold">#${i.id.substring(0, 8)} - ${i.clientName}</p>
                        <p class="text-sm text-white/70">${i.makeModel} (${i.plate}) | Total: ${formatCurrency(i.totalAmount)}</p>
                        <p class="text-xs text-white/50">Fecha: ${formatDate(i.date)} | <span class="px-2 py-0.5 rounded-full text-xs text-white ${statusClass}">${i.status}</span></p>
                    </div>
                    <div>
                        <button onclick="generatePDF('invoice', '${i.id}')" class="text-sm font-semibold text-nexus-gold hover:text-white mr-3">Imprimir PDF</button>
                        <button onclick="deleteDocument('invoices', '${i.id}')" class="text-sm font-semibold text-red-500 hover:text-red-300">Eliminar</button>
                    </div>
                `;
                container.appendChild(invoiceEl);
            });
        }

        window.createInvoiceFromQuote = async (quoteId) => {
            const docSnap = await getDoc(doc(db, getPrivatePath(userId, 'quotes'), quoteId));
            if (docSnap.exists()) {
                const quoteData = docSnap.data();

                // Rellenar formulario de factura con datos de cotización
                document.getElementById('invoice-form').reset();
                document.getElementById('invoice-items-body').innerHTML = '';

                document.getElementById('invoice-client-name').value = quoteData.clientName;
                document.getElementById('invoice-client-phone').value = quoteData.clientPhone;
                document.getElementById('invoice-client-address').value = quoteData.clientAddress;
                document.getElementById('invoice-plate').value = quoteData.plate;
                document.getElementById('invoice-make-model').value = quoteData.makeModel;
                document.getElementById('invoice-vin').value = quoteData.vin;
                document.getElementById('invoice-status').value = 'Pendiente';

                // Rellenar detalles
                quoteData.items.forEach(item => {
                    const total = item.qty * item.price;
                    const row = document.createElement('tr');
                    row.className = 'text-sm border-t border-nexus-gold/20';
                    row.innerHTML = `
                        <td class="p-2">${item.name}</td>
                        <td class="p-2">N/A</td> <!-- Categoría no guardada en el item simple -->
                        <td class="p-2 text-right">${item.qty}</td>
                        <td class="p-2 text-right">${formatCurrency(item.price)}</td>
                        <td class="p-2 text-right font-bold">${formatCurrency(total)}</td>
                        <td class="p-2 text-center">
                            <button type="button" onclick="this.closest('tr').remove(); calculateTotals('invoice')" class="text-red-500 hover:text-red-300">X</button>
                        </td>
                    `;
                    document.getElementById('invoice-items-body').appendChild(row);
                });

                calculateTotals('invoice');
                showPage('invoices');
                showNotification(`Factura iniciada desde Cotización #${quoteId.substring(0, 8)}`, 'info');
            }
        };

        window.saveInvoice = async () => {
            const form = document.getElementById('invoice-form');
            const totals = calculateTotals('invoice');

            const itemsData = Array.from(document.getElementById('invoice-items-body').querySelectorAll('tr')).map(row => {
                return {
                    name: row.children[0].textContent,
                    qty: parseFloat(row.children[2].textContent),
                    price: parseFloat(row.children[3].textContent.replace('$', '').replace(/,/g, '')),
                };
            });

            const data = {
                clientName: form['invoice-client-name'].value,
                clientPhone: form['invoice-client-phone'].value,
                clientAddress: form['invoice-client-address'].value,
                plate: form['invoice-plate'].value,
                makeModel: form['invoice-make-model'].value,
                vin: form['invoice-vin'].value,
                totalAmount: totals.total,
                subtotal: totals.subtotal,
                taxAmount: totals.taxAmount,
                taxRate: parseFloat(form['invoice-tax-rate'].value),
                items: itemsData,
                status: form['invoice-status'].value || 'Pendiente',
                paidAmount: 0, // Se actualizará con los pagos
                paymentMethod: '',
            };
            await saveDocument('invoices', data);
            form.reset();
            document.getElementById('invoice-items-body').innerHTML = '';
            calculateTotals('invoice');
        };

        // --- MÓDULO 7: GENERACIÓN DE PDF (jsPDF) ---

        window.generatePDF = async (docType, docId) => {
            const { jsPDF } = window;
            const pdf = new jsPDF();

            const docSnap = await getDoc(doc(db, getPrivatePath(userId, docType + 's'), docId));
            if (!docSnap.exists()) {
                showNotification(`${docType} no encontrado.`, 'error');
                return;
            }
            const docData = docSnap.data();

            const configSnap = await getDoc(doc(db, getPrivatePath(userId, 'config'), 'workshop'));
            const workshopConfig = configSnap.exists() ? configSnap.data() : { name: 'NEXUS AUTO PRO 2026', address: 'Puerto Rico', phone: 'N/A' };

            // Renderizar items temporalmente para calcular totales y estructura (si no están ya en el documento)
            // Para simplificar, asumiremos que los datos del documento (docData.items) son suficientes.

            const pdfData = {
                type: docType,
                title: docType === 'quote' ? `COTIZACIÓN #${docId.substring(0, 8)}` : `FACTURA #${docId.substring(0, 8)}`,
                workshop: workshopConfig,
                client: {
                    name: docData.clientName,
                    address: docData.clientAddress,
                    phone: docData.clientPhone,
                },
                vehicle: {
                    plate: docData.plate,
                    makeModel: docData.makeModel,
                    vin: docData.vin,
                },
                details: docData.items.map(item => ({
                    name: item.name,
                    qty: item.qty.toString(),
                    price: formatCurrency(item.price),
                    total: formatCurrency(item.qty * item.price)
                })),
                subtotal: formatCurrency(docData.subtotal || docData.totalAmount / 1.115), // Estimación
                taxAmount: formatCurrency(docData.taxAmount || 0),
                total: formatCurrency(docData.totalAmount),
                date: formatDate(docData.createdAt?.toDate() || new Date()),
                status: docData.status || (docType === 'quote' ? 'Borrador' : 'Pendiente'),
            };

            // Estilos
            const black = '#1a1a1a';
            const gold = '#FFD700';

            // Header
            pdf.setFillColor(black);
            pdf.rect(0, 0, 210, 30, 'F');
            pdf.setTextColor(gold);
            pdf.setFontSize(24);
            pdf.text(pdfData.workshop.name, 15, 15);
            pdf.setFontSize(14);
            pdf.text(pdfData.title, 195, 15, { align: 'right' });
            pdf.setFontSize(10);
            pdf.text(`Fecha: ${pdfData.date}`, 195, 23, { align: 'right' });

            // Datos del Taller y Cliente
            let y = 40;
            pdf.setTextColor(black);
            pdf.setFontSize(12);

            pdf.text('DATOS DEL TALLER:', 15, y);
            pdf.setFontSize(10);
            y += 5;
            pdf.text(`Dirección: ${pdfData.workshop.address || 'N/A'}`, 15, y);
            y += 5;
            pdf.text(`Teléfono: ${pdfData.workshop.phone || 'N/A'}`, 15, y);

            y = 40;
            pdf.setFontSize(12);
            pdf.text('DATOS DEL CLIENTE:', 110, y);
            pdf.setFontSize(10);
            y += 5;
            pdf.text(`Nombre: ${pdfData.client.name}`, 110, y);
            y += 5;
            pdf.text(`Dirección: ${pdfData.client.address || 'N/A'}`, 110, y);
            y += 5;
            pdf.text(`Teléfono: ${pdfData.client.phone || 'N/A'}`, 110, y);

            // Datos del Vehículo
            y += 10;
            pdf.setFontSize(12);
            pdf.text('DATOS DEL VEHÍCULO:', 15, y);
            pdf.setFontSize(10);
            y += 5;
            pdf.text(`Tablilla: ${pdfData.vehicle.plate}`, 15, y);
            y += 5;
            pdf.text(`Marca/Modelo: ${pdfData.vehicle.makeModel}`, 15, y);
            y += 5;
            pdf.text(`VIN: ${pdfData.vehicle.vin}`, 15, y);

            // Detalle de Items (Tabla)
            y += 10;
            const tableData = pdfData.details.map(d => [d.name, d.qty, d.price, d.total]);
            const headers = [['Descripción', 'Cant.', 'Precio Unit.', 'Total']];

            pdf.autoTable({
                startY: y,
                head: headers,
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: black, textColor: gold, fontStyle: 'bold' },
                styles: { fontSize: 10, cellPadding: 2, textColor: black },
                columnStyles: {
                    0: { cellWidth: 100 },
                    1: { cellWidth: 20, halign: 'right' },
                    2: { cellWidth: 30, halign: 'right' },
                    3: { cellWidth: 30, halign: 'right' },
                }
            });

            // Totales
            y = pdf.autoTable.previous.finalY + 5;
            pdf.setFontSize(10);
            pdf.text('SUBTOTAL:', 150, y, { align: 'right' });
            pdf.text(pdfData.subtotal, 195, y, { align: 'right' });
            y += 5;

            if (docType === 'invoice') {
                pdf.text('IMPUESTOS (IVU):', 150, y, { align: 'right' });
                pdf.text(pdfData.taxAmount, 195, y, { align: 'right' });
                y += 5;
            }

            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text('TOTAL:', 150, y, { align: 'right' });
            pdf.text(pdfData.total, 195, y, { align: 'right' });

            // Status
            y += 10;
            pdf.setFontSize(10);
            pdf.text(`Estado: ${pdfData.status}`, 15, y);

            pdf.save(`${pdfData.type}-${docId.substring(0, 8)}.pdf`);
            showNotification(`PDF de ${docType} generado con éxito.`, 'success');
        };

        // --- MÓDULO 8: PAGOS Y REPORTES ---

        window.loadPayments = async () => {
            // Cargar facturas para selección de pago
            const q = query(collection(db, getPrivatePath(userId, 'invoices')), where('status', '==', 'Pendiente'));
            onSnapshot(q, (snapshot) => {
                const invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPaymentInvoiceSelect(invoices);
                renderPaymentHistory(); // Cargar historial de pagos después
            }, (error) => console.error("Error al cargar facturas pendientes:", error));
        };

        const renderPaymentInvoiceSelect = (invoices) => {
            const select = document.getElementById('payment-invoice-id');
            select.innerHTML = '<option value="">-- Seleccionar Factura --</option>';

            invoices.forEach(inv => {
                select.innerHTML += `<option value="${inv.id}" data-total="${inv.totalAmount}" data-paid="${inv.paidAmount || 0}">#${inv.id.substring(0, 8)} - ${inv.clientName} (${formatCurrency(inv.totalAmount - (inv.paidAmount || 0))} Pendiente)</option>`;
            });

            // Actualizar monto restante al seleccionar
            select.onchange = () => {
                const selected = select.options[select.selectedIndex];
                const total = parseFloat(selected.getAttribute('data-total')) || 0;
                const paid = parseFloat(selected.getAttribute('data-paid')) || 0;
                const remaining = total - paid;
                document.getElementById('payment-remaining-amount').textContent = formatCurrency(remaining);
                document.getElementById('payment-amount').value = remaining.toFixed(2);
            };
        };

        window.savePayment = async () => {
            const invoiceId = document.getElementById('payment-invoice-id').value;
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const method = document.getElementById('payment-method').value;

            if (!invoiceId || amount <= 0 || !method) {
                showNotification('Complete todos los campos del pago.', 'warning');
                return;
            }

            try {
                await runTransaction(db, async (transaction) => {
                    const invoiceRef = doc(db, getPrivatePath(userId, 'invoices'), invoiceId);
                    const invoiceSnap = await transaction.get(invoiceRef);

                    if (!invoiceSnap.exists()) throw "Factura no existe.";

                    const invoiceData = invoiceSnap.data();
                    const total = invoiceData.totalAmount;
                    const paid = (invoiceData.paidAmount || 0) + amount;
                    let status = 'Pendiente';

                    if (paid >= total) {
                        status = 'Pagada';
                    }

                    // 1. Registrar el pago
                    const paymentData = {
                        invoiceId,
                        clientName: invoiceData.clientName,
                        amount,
                        method,
                        date: serverTimestamp(),
                    };
                    const paymentRef = collection(db, getPrivatePath(userId, 'payments'));
                    transaction.set(doc(paymentRef), paymentData); // Usar setDoc(docRef) para generar ID

                    // 2. Actualizar la factura
                    transaction.update(invoiceRef, {
                        paidAmount: paid,
                        status: status,
                        paymentMethod: method,
                        updatedAt: serverTimestamp(),
                    });

                });
                showNotification(`Pago de ${formatCurrency(amount)} registrado. Estado de Factura actualizado.`, 'success');
                document.getElementById('payment-form').reset();
                document.getElementById('payment-remaining-amount').textContent = formatCurrency(0);
            } catch (error) {
                console.error("Error al registrar pago o actualizar factura:", error);
                showNotification(`Error de transacción: ${error.message}`, 'error');
            }
        };

        const renderPaymentHistory = () => {
            const q = query(collection(db, getPrivatePath(userId, 'payments')));
            onSnapshot(q, (snapshot) => {
                const payments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().date?.toDate() }));
                const container = document.getElementById('payments-history-container');
                container.innerHTML = '';
                payments.sort((a, b) => b.date - a.date);

                payments.forEach(p => {
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center p-2 border-b border-nexus-gold/10 hover:bg-nexus-black/50';
                    el.innerHTML = `
                        <div>
                            <p class="font-semibold text-nexus-gold">${p.clientName}</p>
                            <p class="text-sm text-white/70">Factura #${p.invoiceId.substring(0, 8)} | ${p.method}</p>
                            <p class="text-xs text-white/50">${formatDate(p.date)}</p>
                        </div>
                        <p class="font-bold text-green-500">${formatCurrency(p.amount)}</p>
                    `;
                    container.appendChild(el);
                });
            }, (error) => console.error("Error al cargar historial de pagos:", error));
        };

        // --- MÓDULO 9: HISTORIAL DE ENTREGAS Y CLIENTES ---

        window.loadVehicleHistory = async () => {
             // Cargar entradas de vehículos, que se usan como historial
            const q = query(collection(db, getPrivatePath(userId, 'vehicleEntries')));
            onSnapshot(q, (snapshot) => {
                const entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), entryDate: doc.data().entryDate, status: doc.data().status }));
                renderVehicleHistory(entries);
            }, (error) => console.error("Error al cargar historial:", error));
        };

        const renderVehicleHistory = (entries) => {
            const container = document.getElementById('history-table-body');
            container.innerHTML = '';

            entries.sort((a, b) => new Date(b.entryDate) - new Date(a.entryDate));

            entries.forEach(e => {
                const statusColor = e.status === 'Entregado' ? 'bg-green-600' : (e.status === 'Listo' ? 'bg-blue-600' : 'bg-yellow-600');
                const row = document.createElement('tr');
                row.className = 'hover:bg-nexus-black/50 border-b border-nexus-gold/10';
                row.innerHTML = `
                    <td class="p-2">${e.clientName}</td>
                    <td class="p-2">${e.plate}</td>
                    <td class="p-2">${e.makeModel}</td>
                    <td class="p-2">${e.workType}</td>
                    <td class="p-2">${e.entryDate}</td>
                    <td class="p-2"><span class="px-2 py-0.5 rounded-full text-xs text-white ${statusColor}">${e.status}</span></td>
                    <td class="p-2 text-center">
                        <button onclick="viewEntryDetails('${e.id}')" class="text-xs text-nexus-gold hover:text-white mr-2">Ver Detalle</button>
                    </td>
                `;
                container.appendChild(row);
            });
        };

        window.viewEntryDetails = async (id) => {
            const docSnap = await getDoc(doc(db, getPrivatePath(userId, 'vehicleEntries'), id));
            if (docSnap.exists()) {
                const data = docSnap.data();
                const modal = document.getElementById('detail-modal');
                document.getElementById('detail-modal-title').textContent = `Detalle de Servicio: ${data.plate}`;

                const content = `
                    <p><strong>Cliente:</strong> ${data.clientName} (${data.clientPhone})</p>
                    <p><strong>Vehículo:</strong> ${data.makeModel}, Color: ${data.color}, VIN: ${data.vin}</p>
                    <p><strong>Tipo de Trabajo:</strong> ${data.workType}</p>
                    <p><strong>Diagnóstico:</strong> ${data.diagnosis || 'N/A'}</p>
                    <p><strong>Reparación Mecánica:</strong> ${data.mechRepair || 'N/A'}</p>
                    <p><strong>Reparación Carrocería:</strong> ${data.bodyRepair || 'N/A'}</p>
                    <p><strong>Trabajo de Pintura:</strong> ${data.paintWork || 'N/A'}</p>
                    <p class="mt-4"><strong>Estado:</strong> <span class="px-2 py-0.5 rounded-full text-xs text-white bg-green-600">${data.status}</span></p>
                    <div class="mt-4 p-3 border border-nexus-gold/30 rounded-lg">
                        <h4 class="font-bold text-nexus-gold">Fotos (Drive URLs)</h4>
                        <input type="text" id="photo-url-input" class="w-full mt-2 p-2 bg-gray-800 text-white border border-gray-600 rounded" placeholder="Añadir URL de Google Drive">
                        <button onclick="addPhotoUrl('${id}')" class="mt-2 w-full p-2 bg-nexus-gold text-nexus-black rounded hover:bg-darkGold">Añadir Foto</button>
                        <div id="photo-list" class="mt-2">
                            ${(data.photoUrls || []).map((url, index) =>
                                `<div class="flex justify-between items-center text-sm text-white/70 mt-1">
                                    <a href="${url}" target="_blank" class="truncate hover:underline">Link ${index + 1}</a>
                                    <button onclick="removePhotoUrl('${id}', '${url}')" class="text-red-500 hover:text-red-300 ml-2">X</button>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;

                document.getElementById('detail-modal-content').innerHTML = content;
                modal.classList.remove('hidden');
            }
        };

        window.closeModal = () => {
            document.getElementById('detail-modal').classList.add('hidden');
        };

        window.addPhotoUrl = async (entryId) => {
            const urlInput = document.getElementById('photo-url-input');
            const newUrl = urlInput.value.trim();

            if (!newUrl) {
                showNotification('Ingrese una URL válida.', 'warning');
                return;
            }

            try {
                const entryRef = doc(db, getPrivatePath(userId, 'vehicleEntries'), entryId);
                const docSnap = await getDoc(entryRef);
                const currentUrls = docSnap.exists() ? (docSnap.data().photoUrls || []) : [];

                if (currentUrls.includes(newUrl)) {
                    showNotification('Esta URL ya está registrada.', 'warning');
                    return;
                }

                await updateDoc(entryRef, { photoUrls: [...currentUrls, newUrl] });
                showNotification('URL de foto añadida con éxito.', 'success');
                urlInput.value = '';
                // Recargar el detalle para actualizar la lista de fotos en el modal
                viewEntryDetails(entryId);
            } catch (error) {
                console.error("Error al añadir URL:", error);
                showNotification(`Error al añadir URL: ${error.message}`, 'error');
            }
        };

        window.removePhotoUrl = async (entryId, urlToRemove) => {
            try {
                const entryRef = doc(db, getPrivatePath(userId, 'vehicleEntries'), entryId);
                const docSnap = await getDoc(entryRef);
                const currentUrls = docSnap.exists() ? (docSnap.data().photoUrls || []) : [];
                const updatedUrls = currentUrls.filter(url => url !== urlToRemove);

                await updateDoc(entryRef, { photoUrls: updatedUrls });
                showNotification('URL de foto eliminada con éxito.', 'warning');
                // Recargar el detalle para actualizar la lista de fotos en el modal
                viewEntryDetails(entryId);
            } catch (error) {
                console.error("Error al eliminar URL:", error);
                showNotification(`Error al eliminar URL: ${error.message}`, 'error');
            }
        };


        // --- INICIALIZACIÓN ---
        window.onload = initializeFirebase;

    </script>

    <!-- JS PDF AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Estilos Base y Nexus Look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #ffffff;
        }

        .nexus-gold-button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .nexus-gold-button:hover {
            box-shadow: 0 10px 15px -3px rgba(255, 215, 0, 0.3), 0 4px 6px -4px rgba(255, 215, 0, 0.1);
            transform: translateY(-2px);
        }
        
        /* Estilo para inputs de texto */
        input:not([type="checkbox"]), select, textarea {
            background-color: #2c2c2c !important;
            border-color: #444444 !important;
            color: #ffffff !important;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #FFD700 !important;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.5) !important;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .menu-button {
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-[#121212] font-sans antialiased">

    <!-- Contenedor de Notificaciones -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 max-w-xs w-full">
        <!-- Las notificaciones se insertarán aquí -->
    </div>

    <!-- Pantalla de Autenticación (PIN y Google Auth) -->
    <div id="auth-screen" class="fixed inset-0 flex items-center justify-center bg-nexus-black/95 z-40">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm border-t-4 border-nexus-gold">
            <h1 class="text-3xl font-bold text-nexus-gold mb-6 text-center">NEXUS AUTO PRO 2026</h1>
            <p class="text-white/70 mb-4 text-center">Gestión de Taller en Puerto Rico</p>

            <div class="space-y-4">
                <input type="password" id="pin-input" placeholder="PIN de Acceso (4-6 dígitos)" maxlength="6" class="w-full p-3 rounded-lg text-center text-xl font-mono" onkeypress="if(event.key === 'Enter') handlePinLogin()">
                <button onclick="handlePinLogin()" class="w-full p-3 rounded-lg bg-nexus-gold text-nexus-black font-bold text-lg nexus-gold-button">
                    Entrar con PIN
                </button>
                <div class="flex items-center justify-center space-x-2 my-4">
                    <span class="text-white/50">o</span>
                </div>
                <button onclick="handleGoogleLogin()" class="w-full p-3 rounded-lg bg-blue-600 text-white font-bold text-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c6.627 0 12 5.373 12 12s-5.373 12-12 12S0 18.627 0 12 5.373 0 12 0zm0 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9-4.03-9-9-9zM4.97 12c0 3.86 3.14 7 7 7s7-3.14 7-7-3.14-7-7-7-7 3.14-7 7zM12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z" fill="#fff"/><path d="M12.0000002,12.0000002 L15.7070312,15.7070312 L15.7070312,12.0000002 L12.0000002,12.0000002 Z M12.0000002,12.0000002 L8.29296875,12.0000002 L8.29296875,15.7070312 L12.0000002,15.7070312 L12.0000002,12.0000002 Z M12.0000002,8.29296875 L15.7070312,8.29296875 L15.7070312,12.0000002 L12.0000002,12.0000002 L12.0000002,8.29296875 Z M8.29296875,8.29296875 L12.0000002,8.29296875 L12.0000002,12.0000002 L8.29296875,12.0000002 L8.29296875,8.29296875 Z" fill="#fff" opacity="0"/></svg>
                    Continuar con Google
                </button>
                <p id="user-id-display" class="text-xs text-white/30 mt-4 text-center">ID de Usuario: N/A</p>
            </div>
        </div>
    </div>

    <!-- Aplicación Principal -->
    <div id="main-app" class="app-container hidden">

        <!-- Header / Menú de Navegación Fijo -->
        <header class="bg-nexus-black shadow-lg fixed top-0 left-0 right-0 z-10 border-b border-nexus-gold/50">
            <div class="flex flex-col md:flex-row justify-between items-center p-3 max-w-full mx-auto">
                <div class="flex items-center mb-3 md:mb-0">
                    <h1 id="workshop-name" class="text-xl font-extrabold text-nexus-gold mr-6">NEXUS AUTO PRO 2026</h1>
                </div>

                <!-- Botones del Menú -->
                <nav class="flex flex-wrap gap-2 justify-center md:justify-start overflow-x-auto p-1">
                    <button id="btn-dashboard" class="menu-button bg-nexus-black text-nexus-gold hover:bg-nexus-gold hover:text-nexus-black" onclick="showPage('dashboard')">Inicio</button>
                    <button id="btn-vehicle-entry" class="menu-button bg-nexus-black text-nexus-gold hover:bg-nexus-gold hover:text-nexus-black" onclick="showPage('vehicle-entry')">Entradas Veh.</button>
                    <button id="btn-deliveries-history" class="menu-button bg-nexus-black text-nexus-gold hover:bg-nexus-gold hover:text-nexus-black" onclick="showPage('deliveries-history')">Historial/Entrega</button>
                    <button id="btn-quotes" class="menu-button bg-nexus-black text-nexus-gold hover:bg-nexus-gold hover:text-nexus-black" onclick="showPage('quotes')">Cotizaciones</button>
                    <button id="btn-invoices" class="menu-button bg-nexus-black text-nexus-gold hover:bg-nexus-gold hover:text-nexus-black" onclick="showPage('invoices')">Facturas</button>
                    <button id="btn-price-list" class="menu-button bg-nexus-black text-nexus-gold hover:bg-nexus-gold hover:text-nexus-black" onclick="showPage('price-list')">Lista Precios</button>
                    <button id="btn-clients" class="menu-button bg-nexus-black text-nexus-gold hover:bg-nexus-gold hover:text-nexus-black" onclick="showPage('clients')">Clientes</button>
                    <button id="btn-suppliers" class="menu-button bg-nexus-black text-nexus-gold hover:bg-nexus-gold hover:text-nexus-black" onclick="showPage('suppliers')">Suplidores</button>
                    <button id="btn-payments-reports" class="menu-button bg-nexus-black text-nexus-gold hover:bg-nexus-gold hover:text-nexus-black" onclick="showPage('payments-reports')">Pagos/Reportes</button>
                    <button id="btn-settings" class="menu-button bg-nexus-black text-nexus-gold hover:bg-nexus-gold hover:text-nexus-black" onclick="showPage('settings')">Configuración</button>
                    <button id="btn-logout" class="menu-button bg-red-600 text-white hover:bg-red-700 transition-colors" onclick="showPinScreen()">Salir</button>
                </nav>
            </div>
        </header>

        <!-- Contenido Principal -->
        <main class="flex-grow pt-[100px] md:pt-[70px] p-4">
            <div class="max-w-7xl mx-auto space-y-8">

                <!-- 1. DASHBOARD -->
                <div id="page-dashboard" class="app-page hidden p-6 bg-gray-800/80 rounded-xl shadow-xl border-t-4 border-nexus-gold">
                    <h2 class="text-3xl font-bold text-nexus-gold mb-6">Dashboard / Inicio</h2>
                    <p class="text-white/70">Bienvenido al sistema NEXUS AUTO PRO 2026. Utilice el menú superior para navegar por los módulos.</p>
                    <!-- Aquí se mostrarían métricas clave (facturas pendientes, vehículos en reparación, etc.) -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                        <div class="bg-gray-700 p-5 rounded-lg border-l-4 border-yellow-500">
                            <p class="text-sm font-semibold text-yellow-300">Facturas Pendientes</p>
                            <p class="text-2xl font-bold text-white">$1,200.00 <span class="text-sm font-normal text-white/50">(Simulación)</span></p>
                        </div>
                        <div class="bg-gray-700 p-5 rounded-lg border-l-4 border-blue-500">
                            <p class="text-sm font-semibold text-blue-300">Vehículos en Taller</p>
                            <p class="text-2xl font-bold text-white">5 <span class="text-sm font-normal text-white/50">(Simulación)</span></p>
                        </div>
                        <div class="bg-gray-700 p-5 rounded-lg border-l-4 border-green-500">
                            <p class="text-sm font-semibold text-green-300">Pagos Recibidos Hoy</p>
                            <p class="text-2xl font-bold text-white">$350.00 <span class="text-sm font-normal text-white/50">(Simulación)</span></p>
                        </div>
                    </div>
                </div>

                <!-- 2. REGISTRO DE ENTRADA DE VEHÍCULOS -->
                <div id="page-vehicle-entry" class="app-page hidden p-6 bg-gray-800/80 rounded-xl shadow-xl border-t-4 border-nexus-gold">
                    <h2 class="text-3xl font-bold text-nexus-gold mb-6">Registro de Entrada de Vehículo</h2>
                    <form id="vehicle-entry-form" onsubmit="event.preventDefault(); saveVehicleEntry()" class="space-y-4">

                        <h3 class="text-xl font-semibold text-white/90">Datos del Cliente y Vehículo</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input name="entry-client-name" type="text" placeholder="Nombre del Cliente" required class="p-3 w-full">
                            <input name="entry-client-phone" type="tel" placeholder="Número de Teléfono" required class="p-3 w-full">
                            <input name="entry-client-address" type="text" placeholder="Dirección del Cliente" class="p-3 w-full">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input name="entry-plate" type="text" placeholder="Tablilla del Vehículo" required class="p-3 w-full">
                            <input name="entry-make-model" type="text" placeholder="Marca y Modelo" required class="p-3 w-full">
                            <input name="entry-vin" type="text" placeholder="VIN Number" class="p-3 w-full">
                            <input name="entry-color" type="text" placeholder="Color" class="p-3 w-full">
                        </div>

                        <h3 class="text-xl font-semibold text-white/90 pt-4">Detalles del Trabajo</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-white/70 mb-1">Tipo de Trabajo Principal</label>
                                <select name="entry-work-type" required class="p-3 w-full">
                                    <option value="">-- Seleccionar Categoría --</option>
                                    <option value="Mecanica">Mecánica</option>
                                    <option value="Hojalateria">Hojalatería</option>
                                    <option value="Pintura">Pintura</option>
                                    <option value="Detailing">Detailing</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-white/70 mb-1">Fecha de Entrada</label>
                                <input name="entry-date" type="date" required class="p-3 w-full" value="<?= date('Y-m-d') ?>">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-white/70 mb-1">Estado del Vehículo</label>
                                <select name="entry-status" required class="p-3 w-full">
                                    <option value="En Reparacion">En Reparación</option>
                                    <option value="Listo">Listo para Entrega</option>
                                    <option value="Entregado">Entregado</option>
                                    <option value="En Espera Piezas">En Espera de Piezas</option>
                                </select>
                            </div>
                        </div>

                        <textarea name="entry-suggested-work" rows="2" placeholder="Trabajo Sugerido/Notas Iniciales" class="p-3 w-full"></textarea>
                        <textarea name="entry-diagnosis" rows="3" placeholder="Diagnóstico Inicial / Descripción del Problema" class="p-3 w-full"></textarea>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <textarea name="entry-mech-repair" rows="3" placeholder="Reparación Mecánica (Detalles)" class="p-3 w-full"></textarea>
                            <textarea name="entry-body-repair" rows="3" placeholder="Reparación de Carrocería (Detalles)" class="p-3 w-full"></textarea>
                            <textarea name="entry-paint-work" rows="3" placeholder="Trabajo de Pintura (Detalles)" class="p-3 w-full"></textarea>
                        </div>

                        <button type="submit" class="w-full p-3 rounded-lg bg-nexus-gold text-nexus-black font-bold nexus-gold-button">
                            Guardar Registro de Entrada
                        </button>
                    </form>
                </div>

                <!-- 3. HISTORIAL Y ENTREGAS -->
                <div id="page-deliveries-history" class="app-page hidden p-6 bg-gray-800/80 rounded-xl shadow-xl border-t-4 border-nexus-gold">
                    <h2 class="text-3xl font-bold text-nexus-gold mb-6">Historial de Vehículos y Entregas</h2>

                    <div class="overflow-x-auto bg-gray-700/50 p-4 rounded-lg">
                        <table class="min-w-full table-auto text-white/90">
                            <thead>
                                <tr class="bg-nexus-black text-nexus-gold uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Cliente</th>
                                    <th class="py-3 px-6 text-left">Tablilla</th>
                                    <th class="py-3 px-6 text-left">Marca/Modelo</th>
                                    <th class="py-3 px-6 text-left">Trabajo</th>
                                    <th class="py-3 px-6 text-left">Entrada</th>
                                    <th class="py-3 px-6 text-center">Estado</th>
                                    <th class="py-3 px-6 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="text-white/80 text-sm font-light">
                                <!-- Contenido dinámico de vehicleEntries -->
                                <tr><td colspan="7" class="text-center p-4 text-white/50">Cargando historial de vehículos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 4. COTIZACIONES -->
                <div id="page-quotes" class="app-page hidden p-6 bg-gray-800/80 rounded-xl shadow-xl border-t-4 border-nexus-gold">
                    <h2 class="text-3xl font-bold text-nexus-gold mb-6">Módulo de Cotizaciones</h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Formulario de Creación/Edición -->
                        <div class="bg-gray-700 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-nexus-gold mb-4">Nueva Cotización</h3>
                            <form id="quote-form" onsubmit="event.preventDefault(); saveQuote()" class="space-y-4">
                                <input name="quote-client-name" type="text" placeholder="Nombre del Cliente" required class="p-3 w-full">
                                <div class="grid grid-cols-2 gap-2">
                                    <input name="quote-client-phone" type="tel" placeholder="Teléfono" class="p-3 w-full">
                                    <input name="quote-client-address" type="text" placeholder="Dirección" class="p-3 w-full">
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <input name="quote-plate" type="text" placeholder="Tablilla" class="p-3 w-full">
                                    <input name="quote-make-model" type="text" placeholder="Marca/Modelo" class="p-3 w-full">
                                    <input name="quote-vin" type="text" placeholder="VIN" class="p-3 w-full">
                                </div>

                                <h4 class="text-lg font-semibold text-white/90 pt-3">Detalle de Servicios</h4>
                                <div class="flex space-x-2">
                                    <select id="quote-price-item-select" class="flex-grow p-3" onfocus="loadPriceItemsToSelect('quote-price-item-select')">
                                        <option value="">-- Seleccionar Ítem de Lista de Precios --</option>
                                    </select>
                                    <input type="number" id="quote-item-qty" value="1" min="1" class="w-20 p-3 text-right">
                                    <button type="button" onclick="addItemToDocument('quote')" class="p-3 bg-nexus-gold text-nexus-black rounded-lg hover:bg-darkGold">Añadir</button>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-white/90">
                                        <thead>
                                            <tr class="bg-nexus-black/50 text-nexus-gold text-sm">
                                                <th class="p-2 text-left">Servicio/Pieza</th><th class="p-2">Cat.</th><th class="p-2 text-right">Cant.</th><th class="p-2 text-right">P. Unit.</th><th class="p-2 text-right">Total</th><th class="p-2 text-center"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="quote-items-body">
                                            <!-- Items dinámicos -->
                                        </tbody>
                                    </table>
                                </div>

                                <div class="text-right text-lg font-bold text-white/90">
                                    <p>Subtotal: <span id="quote-subtotal">$0.00</span></p>
                                    <p class="text-2xl text-nexus-gold mt-2">TOTAL: <span id="quote-total">$0.00</span></p>
                                </div>

                                <button type="submit" class="w-full p-3 rounded-lg bg-nexus-gold text-nexus-black font-bold nexus-gold-button">
                                    Guardar Cotización
                                </button>
                            </form>
                        </div>

                        <!-- Historial de Cotizaciones -->
                        <div class="bg-gray-700 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-nexus-gold mb-4">Historial de Cotizaciones</h3>
                            <div id="quotes-list-container" class="space-y-2 max-h-[600px] overflow-y-auto">
                                <p class="text-white/50">Cargando historial...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. FACTURAS -->
                <div id="page-invoices" class="app-page hidden p-6 bg-gray-800/80 rounded-xl shadow-xl border-t-4 border-nexus-gold">
                    <h2 class="text-3xl font-bold text-nexus-gold mb-6">Módulo de Facturación</h2>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Formulario de Creación/Edición -->
                        <div class="bg-gray-700 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-nexus-gold mb-4">Nueva Factura</h3>
                            <form id="invoice-form" onsubmit="event.preventDefault(); saveInvoice()" class="space-y-4">
                                <input name="invoice-client-name" id="invoice-client-name" type="text" placeholder="Nombre del Cliente" required class="p-3 w-full">
                                <div class="grid grid-cols-2 gap-2">
                                    <input name="invoice-client-phone" id="invoice-client-phone" type="tel" placeholder="Teléfono" class="p-3 w-full">
                                    <input name="invoice-client-address" id="invoice-client-address" type="text" placeholder="Dirección" class="p-3 w-full">
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <input name="invoice-plate" id="invoice-plate" type="text" placeholder="Tablilla" class="p-3 w-full">
                                    <input name="invoice-make-model" id="invoice-make-model" type="text" placeholder="Marca/Modelo" class="p-3 w-full">
                                    <input name="invoice-vin" id="invoice-vin" type="text" placeholder="VIN" class="p-3 w-full">
                                </div>

                                <h4 class="text-lg font-semibold text-white/90 pt-3">Detalle de Servicios</h4>
                                <div class="flex space-x-2">
                                    <select id="invoice-price-item-select" class="flex-grow p-3" onfocus="loadPriceItemsToSelect('invoice-price-item-select')">
                                        <option value="">-- Seleccionar Ítem de Lista de Precios --</option>
                                    </select>
                                    <input type="number" id="invoice-item-qty" value="1" min="1" class="w-20 p-3 text-right">
                                    <button type="button" onclick="addItemToDocument('invoice')" class="p-3 bg-nexus-gold text-nexus-black rounded-lg hover:bg-darkGold">Añadir</button>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-white/90">
                                        <thead>
                                            <tr class="bg-nexus-black/50 text-nexus-gold text-sm">
                                                <th class="p-2 text-left">Servicio/Pieza</th><th class="p-2">Cat.</th><th class="p-2 text-right">Cant.</th><th class="p-2 text-right">P. Unit.</th><th class="p-2 text-right">Total</th><th class="p-2 text-center"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="invoice-items-body">
                                            <!-- Items dinámicos -->
                                        </tbody>
                                    </table>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <select name="invoice-status" id="invoice-status" class="p-3 w-full">
                                        <option value="Pendiente">Pendiente de Pago</option>
                                        <option value="Pagada">Pagada</option>
                                    </select>
                                    <input name="invoice-tax-rate" id="invoice-tax-rate" type="number" step="0.01" value="11.5" placeholder="Tasa de Impuesto (%)" oninput="calculateTotals('invoice')" class="p-3 w-full">
                                </div>

                                <div class="text-right text-lg font-bold text-white/90">
                                    <p>Subtotal: <span id="invoice-subtotal">$0.00</span></p>
                                    <p>Impuestos (IVU): <span id="invoice-tax-amount">$0.00</span></p>
                                    <p class="text-2xl text-nexus-gold mt-2">TOTAL: <span id="invoice-total">$0.00</span></p>
                                </div>

                                <button type="submit" class="w-full p-3 rounded-lg bg-nexus-gold text-nexus-black font-bold nexus-gold-button">
                                    Guardar Factura
                                </button>
                            </form>
                        </div>

                        <!-- Historial de Facturas -->
                        <div class="bg-gray-700 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-nexus-gold mb-4">Historial de Facturas</h3>
                            <div id="invoices-list-container" class="space-y-2 max-h-[600px] overflow-y-auto">
                                <p class="text-white/50">Cargando historial...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 6. LISTA DE PRECIOS -->
                <div id="page-price-list" class="app-page hidden p-6 bg-gray-800/80 rounded-xl shadow-xl border-t-4 border-nexus-gold">
                    <h2 class="text-3xl font-bold text-nexus-gold mb-6">Lista Maestra de Precios</h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Formulario de Creación/Edición -->
                        <div class="bg-gray-700 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-nexus-gold mb-4">Añadir/Editar Ítem</h3>
                            <form id="price-item-form" onsubmit="event.preventDefault(); savePriceItem()" class="space-y-4">
                                <input type="hidden" id="price-item-id">
                                <input type="text" id="price-item-name" placeholder="Nombre del Servicio/Pieza" required class="p-3 w-full">
                                <select id="price-item-category" required class="p-3 w-full">
                                    <option value="">-- Categoría --</option>
                                    <option value="Mecanica">Mecánica</option>
                                    <option value="Hojalateria">Hojalatería</option>
                                    <option value="Pintura">Pintura</option>
                                    <option value="Detailing">Detailing</option>
                                    <option value="Otros">Otros</option>
                                </select>
                                <textarea id="price-item-description" rows="2" placeholder="Descripción (opcional)" class="p-3 w-full"></textarea>
                                <input type="number" id="price-item-price" step="0.01" placeholder="Precio Unitario (USD)" required class="p-3 w-full">
                                <button type="submit" class="w-full p-3 rounded-lg bg-nexus-gold text-nexus-black font-bold nexus-gold-button">
                                    Guardar Ítem de Precio
                                </button>
                            </form>
                        </div>

                        <!-- Lista de Precios -->
                        <div class="bg-gray-700 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-nexus-gold mb-4">Ítems Registrados</h3>
                            <div id="price-list-container" class="space-y-2 max-h-[600px] overflow-y-auto">
                                <p class="text-white/50">Cargando lista de precios...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 7. CLIENTES -->
                <div id="page-clients" class="app-page hidden p-6 bg-gray-800/80 rounded-xl shadow-xl border-t-4 border-nexus-gold">
                    <h2 class="text-3xl font-bold text-nexus-gold mb-6">Lista Maestra de Clientes</h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Formulario de Creación/Edición -->
                        <div class="bg-gray-700 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-nexus-gold mb-4">Añadir/Editar Cliente</h3>
                            <form id="client-form" onsubmit="event.preventDefault(); saveClient()" class="space-y-4">
                                <input type="hidden" id="client-id">
                                <input type="text" id="client-name" placeholder="Nombre Completo" required class="p-3 w-full">
                                <input type="tel" id="client-phone" placeholder="Número de Teléfono" required class="p-3 w-full">
                                <input type="email" id="client-email" placeholder="Correo Electrónico (opcional)" class="p-3 w-full">
                                <input type="text" id="client-address" placeholder="Dirección Postal" class="p-3 w-full">
                                <button type="submit" class="w-full p-3 rounded-lg bg-nexus-gold text-nexus-black font-bold nexus-gold-button">
                                    Guardar Cliente
                                </button>
                            </form>
                        </div>

                        <!-- Lista de Clientes -->
                        <div class="bg-gray-700 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-nexus-gold mb-4">Clientes Registrados</h3>
                            <div id="clients-list-container" class="space-y-2 max-h-[600px] overflow-y-auto">
                                <p class="text-white/50">Cargando clientes...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 8. SUPLIDORES -->
                <div id="page-suppliers" class="app-page hidden p-6 bg-gray-800/80 rounded-xl shadow-xl border-t-4 border-nexus-gold">
                    <h2 class="text-3xl font-bold text-nexus-gold mb-6">Lista Maestra de Suplidores</h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Formulario de Creación/Edición -->
                        <div class="bg-gray-700 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-nexus-gold mb-4">Añadir/Editar Suplidor</h3>
                            <form id="supplier-form" onsubmit="event.preventDefault(); saveSupplier()" class="space-y-4">
                                <input type="hidden" id="supplier-id">
                                <input type="text" id="supplier-name" placeholder="Nombre de la Compañía" required class="p-3 w-full">
                                <input type="tel" id="supplier-phone" placeholder="Teléfono" class="p-3 w-full">
                                <input type="email" id="supplier-email" placeholder="Correo Electrónico" class="p-3 w-full">
                                <input type="text" id="supplier-address" placeholder="Dirección" class="p-3 w-full">
                                <textarea id="supplier-notes" rows="2" placeholder="Notas/Términos de Pago" class="p-3 w-full"></textarea>
                                <button type="submit" class="w-full p-3 rounded-lg bg-nexus-gold text-nexus-black font-bold nexus-gold-button">
                                    Guardar Suplidor
                                </button>
                            </form>
                        </div>

                        <!-- Lista de Suplidores -->
                        <div class="bg-gray-700 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-nexus-gold mb-4">Suplidores Registrados</h3>
                            <div id="suppliers-list-container" class="space-y-2 max-h-[600px] overflow-y-auto">
                                <p class="text-white/50">Cargando suplidores...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 9. PAGOS Y REPORTES -->
                <div id="page-payments-reports" class="app-page hidden p-6 bg-gray-800/80 rounded-xl shadow-xl border-t-4 border-nexus-gold">
                    <h2 class="text-3xl font-bold text-nexus-gold mb-6">Pagos Recibidos y Reportes</h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Registro de Pago -->
                        <div class="bg-gray-700 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-nexus-gold mb-4">Registrar Pago a Factura</h3>
                            <form id="payment-form" onsubmit="event.preventDefault(); savePayment()" class="space-y-4">
                                <select id="payment-invoice-id" required class="p-3 w-full">
                                    <option value="">-- Seleccionar Factura Pendiente --</option>
                                    <!-- Opciones dinámicas -->
                                </select>
                                <div class="text-right text-sm text-white/70">Monto Pendiente: <span id="payment-remaining-amount" class="font-bold text-nexus-gold">$0.00</span></div>
                                <input type="number" id="payment-amount" step="0.01" min="0.01" placeholder="Monto del Pago" required class="p-3 w-full">
                                <select id="payment-method" required class="p-3 w-full">
                                    <option value="">-- Método de Pago --</option>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Tarjeta">Tarjeta de Crédito/Débito</option>
                                    <option value="Transferencia">Transferencia Bancaria (ATH Móvil)</option>
                                    <option value="Cheque">Cheque</option>
                                </select>
                                <button type="submit" class="w-full p-3 rounded-lg bg-nexus-gold text-nexus-black font-bold nexus-gold-button">
                                    Registrar Pago
                                </button>
                            </form>
                            <button onclick="alert('Funcionalidad de Reporte PDF (Facturas Pagadas/Pendientes) en desarrollo con jsPDF.')" class="w-full mt-4 p-3 rounded-lg bg-gray-600 text-white font-bold hover:bg-gray-500">
                                Generar Reporte de Facturas
                            </button>
                        </div>

                        <!-- Historial de Pagos -->
                        <div class="bg-gray-700 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-nexus-gold mb-4">Historial de Pagos Recibidos</h3>
                            <div id="payments-history-container" class="space-y-2 max-h-[600px] overflow-y-auto">
                                <p class="text-white/50">Cargando historial de pagos...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 10. CONFIGURACIÓN -->
                <div id="page-settings" class="app-page hidden p-6 bg-gray-800/80 rounded-xl shadow-xl border-t-4 border-nexus-gold">
                    <h2 class="text-3xl font-bold text-nexus-gold mb-6">Configuración del Taller</h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Información del Taller -->
                        <div class="bg-gray-700 p-6 rounded-xl space-y-4">
                            <h3 class="text-xl font-semibold text-nexus-gold">Información General</h3>
                            <input type="text" id="config-workshop-name" placeholder="Nombre del Taller" required class="p-3 w-full">
                            <input type="text" id="config-address" placeholder="Dirección" class="p-3 w-full">
                            <input type="tel" id="config-phone" placeholder="Teléfono" class="p-3 w-full">
                            <input type="email" id="config-email" placeholder="Email" class="p-3 w-full">
                            <input type="text" id="config-hours" placeholder="Horario de Operación" class="p-3 w-full">
                            <input type="url" id="config-logo" placeholder="URL de Logo (Google Drive, etc.)" class="p-3 w-full">
                            <button onclick="saveWorkshopConfig()" class="w-full p-3 rounded-lg bg-nexus-gold text-nexus-black font-bold nexus-gold-button">
                                Guardar Configuración
                            </button>
                        </div>

                        <!-- Seguridad y Firebase -->
                        <div class="bg-gray-700 p-6 rounded-xl space-y-4">
                            <h3 class="text-xl font-semibold text-nexus-gold">Seguridad y Acceso</h3>
                            <p class="text-sm text-white/70">PIN de Acceso Actual: <span id="current-pin-display" class="font-bold">2026 (Default)</span></p>

                            <h4 class="font-semibold text-white/90 pt-2">Cambiar PIN</h4>
                            <input type="password" id="config-old-pin" placeholder="PIN Anterior" maxlength="6" class="p-3 w-full">
                            <input type="password" id="config-new-pin" placeholder="Nuevo PIN (4-6 dígitos)" maxlength="6" class="p-3 w-full">
                            <input type="password" id="config-confirm-pin" placeholder="Confirmar Nuevo PIN" maxlength="6" class="p-3 w-full">
                            <button onclick="changePin()" class="w-full p-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700">
                                Cambiar PIN
                            </button>

                            <h4 class="font-semibold text-white/90 pt-4">Información de Conexión</h4>
                            <p class="text-xs text-white/50 break-words">
                                Proyecto ID: ${firebaseConfig.projectId}<br>
                                App ID: ${firebaseConfig.appId}<br>
                                Dominio Auth: ${firebaseConfig.authDomain}
                            </p>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modal de Detalle/Historial -->
    <div id="detail-modal" class="fixed inset-0 bg-nexus-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-2xl border-t-4 border-nexus-gold">
            <div class="flex justify-between items-center mb-4">
                <h3 id="detail-modal-title" class="text-2xl font-bold text-nexus-gold">Detalle del Historial</h3>
                <button onclick="closeModal()" class="text-white hover:text-red-500 text-3xl">&times;</button>
            </div>
            <div id="detail-modal-content" class="text-white space-y-2 max-h-[80vh] overflow-y-auto">
                <!-- Contenido dinámico -->
            </div>
        </div>
    </div>

</body>
</html>
